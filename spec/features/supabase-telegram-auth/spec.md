# Авторизация Telegram Mini App через Supabase

**Specification:** Реализовать бесшовную авторизацию Telegram Mini App в Nuxt 4 приложении через Supabase Auth: проверять `initData` на сервере, проксировать валидированный пакет в Supabase Edge Function, получать готовые `access_token`/`refresh_token` и сессию пользователя, а на клиенте устанавливать её через `supabase.auth.setSession()` без повторного логина при последующих открытиях.

## User Stories

- Как пользователь Mini App, я открываю приложение в Telegram и сразу получаю доступ к функциональности без ввода логина и пароля, потому что бот авторизует меня по проверенным данным Telegram.
- Как повторно возвращающийся пользователь, я открываю Mini App и продолжаю работу с сохранённой Supabase-сессией, потому что повторная авторизация не требуется пока токены действительны.
- Как администратор продукта, я хочу, чтобы новые пользователи автоматически создавались в Supabase при первом запуске Mini App, чтобы управлять доступом и профилями из единой админ-панели.

## Main scenarios and rules

- При первом запуске Mini App клиент инициирует обращение к серверному маршруту Nuxt, передавая `initData` из Telegram WebApp. Сервер валидирует подпись через `@telegram-apps/init-data-node`. При успехе данные отправляются в Supabase Edge Function. Ответ с `access_token`, `refresh_token` и объектом `user` проксируется клиенту, который вызывает `supabase.auth.setSession()` и сохраняет сессию.
- При повторном открытии Mini App клиент сначала проверяет актуальность локальной Supabase-сессии (`supabase.auth.getSession()`). Если сессия валидна — серверная авторизация не вызывается, используется существующий пользователь.
- Если валидация `initData` не проходит или Supabase Edge Function возвращает ошибку, клиент должен показать понятное сообщение об ошибке и не устанавливать сессию. Ошибки логируются на сервере с минимизацией утечки чувствительных данных.
- Серверная валидация должна учитывать возможные атаки: проверять timestamp на устаревание, ограничивать размер `initData`, предотвращать повторное использование.

## Non-functional requirements

- Безопасность: использовать HTTPS, секреты бота хранить в переменных окружения, не логировать токены в явном виде.
- Производительность: валидация и обращение к Edge Function не должны увеличивать время загрузки Mini App более чем на 300 мс в среднем при стабильном соединении.
- Надёжность: предусмотреть повторный вызов Edge Function при транзиентных ошибках и тайм-аут 5 секунд.
- Локализация: сообщения об ошибках и UI — на русском языке.
- Наблюдаемость: логировать ключевые этапы (успешная/неуспешная валидация, результаты Edge Function) с корреляционным ID запроса.

## Assumptions

- Supabase проект уже развёрнут, Edge Functions доступны и могут создавать пользователей через Admin API.
- Клиентский SDK Supabase уже инициализирован в Nuxt приложении и поддерживает `auth.setSession`.
- Токены Telegram Mini App поступают в `initData` корректно и содержат `user.id`.
- Требования к ролям и дополнительным профилям пользователей будут уточнены отдельно, здесь обрабатывается только базовая авторизация.
